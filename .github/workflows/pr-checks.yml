name: PR Checks

permissions: read-all

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  # Main CI job that runs all required checks
  pr-checks:
    name: 'ğŸš€ PR Validation'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§° Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.19'

      - name: ğŸŒ Setup Chrome for tests
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            packages/*/node_modules
          key: bun-deps-${{ runner.os }}-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            bun-deps-${{ runner.os }}-

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ¨ Check code formatting
        id: format-check
        run: |
          echo "### ğŸ¨ Format Check" >> $GITHUB_STEP_SUMMARY
          if bun run check-format; then
            echo "âœ… Code formatting is correct" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Code formatting issues found. Run 'bun run format' to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ğŸ§ª Run all tests
        id: test-all
        run: |
          echo "### ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          bun test:all 2>&1 | tee test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          tail -5 test-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit $TEST_EXIT_CODE
        env:
          CI: true
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      - name: ğŸ“Š Run tests with coverage
        id: test-coverage
        run: |
          echo "### ğŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          bun test --coverage 2>&1 | tee coverage-output.txt
          COVERAGE_EXIT_CODE=${PIPESTATUS[0]}
          # Extract coverage summary (last 10 lines usually contain the summary)
          tail -10 coverage-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit $COVERAGE_EXIT_CODE
        env:
          CI: true
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      - name: ğŸ“¤ Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-output.txt
            coverage-output.txt
            coverage/
          retention-days: 7

      - name: ğŸ’¬ Comment PR (success)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âœ… All PR checks passed!

            - ğŸ¨ **Format Check**: Passed
            - ğŸ§ª **All Tests**: Passed
            - ğŸ“Š **Coverage Tests**: Passed

            Great work! Your PR is ready for review.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸ’¬ Comment PR (failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const formatStatus = '${{ steps.format-check.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
            const testStatus = '${{ steps.test-all.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
            const coverageStatus = '${{ steps.test-coverage.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';

            const comment = `## âŒ PR checks failed

            | Check | Status | Action Required |
            |-------|--------|-----------------|
            | ğŸ¨ Format Check | ${formatStatus} | ${formatStatus.includes('Failed') ? 'Run `bun run format`' : 'None'} |
            | ğŸ§ª All Tests | ${testStatus} | ${testStatus.includes('Failed') ? 'Fix failing tests' : 'None'} |
            | ğŸ“Š Coverage Tests | ${coverageStatus} | ${coverageStatus.includes('Failed') ? 'Check coverage report' : 'None'} |

            Please fix the issues and push the changes.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });